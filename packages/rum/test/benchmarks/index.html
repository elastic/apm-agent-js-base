<!DOCTYPE html>
<html>
  <head>
    <title>Elastic APM RUM agent Benchmarks</title>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="icon" href="data:;base64,iVBORw0KGgo=" />
  </head>

  <body>
    <h2>Elastic APM RUM agent Benchmarks v4.1.2</h2>
    <p>All tests are median of 51</p>
    <pre id="display"></pre>
    <script>
      !(function(r) {
        'use strict'
        function n(r) {
          if (!r) throw new Error('name must be non-empty')
        }
        function e(r, n) {
          for (var e, t = 0, a = r.length; t < a; )
            (e = (t + a) >>> 1),
              r[e].startTime < n.startTime ? (t = e + 1) : (a = e)
          r.splice(t, 0, n)
        }
        var t = 'undefined' != typeof performance && performance,
          a =
            t && t.now
              ? function() {
                  return t.now()
                }
              : function() {
                  return Date.now()
                }
        if (t && t.mark)
          (r.mark = function(r) {
            n(r), t.mark('start ' + r)
          }),
            (r.stop = function(r) {
              n(r), t.mark('end ' + r), t.measure(r, 'start ' + r, 'end ' + r)
              var e = t.getEntriesByName(r)
              return e[e.length - 1]
            }),
            (r.getEntries = function() {
              return t.getEntriesByType('measure')
            }),
            (r.clear = function() {
              t.clearMarks(), t.clearMeasures()
            })
        else {
          var o = {},
            i = []
          ;(r.mark = function(r) {
            n(r)
            var e = a()
            o['$' + r] = e
          }),
            (r.stop = function(r) {
              n(r)
              var t = a(),
                u = o['$' + r]
              if (!u) throw new Error('no known mark: ' + r)
              var s = {
                startTime: u,
                name: r,
                duration: t - u,
                entryType: 'measure'
              }
              return e(i, s), s
            }),
            (r.getEntries = function() {
              return i
            }),
            (r.clear = function() {
              ;(o = {}), (i = [])
            })
        }
      })((this.marky = this.marky || {}))
    </script>
    <script>
      ;(function() {
        var originalWindowKeys
        function cleanupScript() {
          // if the script added keys to the window, remove them to avoid memory leaks
          Object.keys(window).forEach(function(key) {
            if (!~originalWindowKeys.indexOf(key)) {
              delete window[key]
            }
          })
          document.body.removeChild(
            document.querySelector('body script:last-child')
          )
        }

        function loadScript(src, num, cb) {
          var times = {
            parse: [],
            init: []
          }
          window.__onDone = function(entry) {
            times.parse.push(entry.duration)
            var initEntry = initScript()
            times.init.push(initEntry.duration)
            cleanupScript()
            if (--num > 0) {
              load()
            } else {
              if (!cb) {
                console.log(times)
              } else {
                cb(times)
              }
            }
          }

          function load() {
            originalWindowKeys = Object.keys(window)

            // adding a random value to the script text prevents Chrome from
            // caching the parsed/JITed script. we also use this as the mark/measure name
            var rando = 'script_' + btoa(Math.random())
            var xhr = new XMLHttpRequest()
            xhr.onload = function() {
              var scriptText =
                xhr.responseText.replace(
                  '//# sourceMappingURL=elastic-apm-rum.umd.min.js.map',
                  ''
                ) +
                ';__onDone(marky.stop("' +
                rando +
                '"))'
              var scriptEl = document.createElement('script')
              scriptEl.textContent = scriptText
              marky.mark(rando)
              document.body.appendChild(scriptEl)
            }
            xhr.open('GET', src)
            xhr.send()
          }
          load()
        }

        function initScript() {
          const apmServer = elasticApm.serviceFactory.getService('ApmServer')
          const apmserverProto = Object.getPrototypeOf(apmServer)
          const postJson = apmserverProto._postJson

          apmserverProto._postJson = (endpoint, payload) => {
            // Skip posting data to apm server
            // postJson.call(apmserverProto, endpoint, payload)
          }

          var rando = 'init_' + btoa(Math.random())
          marky.mark(rando)
          elasticApm.init({
            serviceName: 'test',
            serverUrl: 'http://localhost:8001'
          })
          return marky.stop(rando)
        }

        window.loadScript = loadScript

        loadScript(
          'https://unpkg.com/@elastic/apm-rum@4.1.2/dist/bundles/elastic-apm-rum.umd.min.js',
          51,
          function(times) {
            var getMedian = function(type) {
              return times[type].sort(function(left, right) {
                return left < right ? -1 : 1
              })[~~(times[type].length / 2)]
            }
            var parse = getMedian('parse')
            var init = getMedian('init')
            var html = 'parse & exec time: ' + parse.toFixed(2) + ' ms\n'
            html += 'apm initialization time: ' + init.toFixed(2) + ' ms\n'
            display.innerHTML = html
          }
        )
      })()
    </script>
  </body>
</html>
